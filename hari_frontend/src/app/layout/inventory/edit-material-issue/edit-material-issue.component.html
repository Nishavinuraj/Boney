<div class="container">
  <form [formGroup]="miForm">
    <div class="card">
      <div class="card-header">Edit Material Issue</div>
      <div class="card-body">

        <div class="form-group row">
          <div class="col-lg-3 col-md-3">
            <label class="required">Site</label>
            <ng-select [items]="siteOptions" placeholder="Type and search site" bindLabel="branch_name" bindValue="branch_name"
              formControlName="site">
            </ng-select>
          </div>
          <div class="col-lg-3 col-md-3">
            <label class="required">MI type</label>
            <select class="form-control" formControlName="mi_type" (change)="generateMiNumber()">
              <option value="">Select MI type</option>
              <option value="Issue">Issue</option>
              <option value="Issue Return">Issue Return</option>
            </select>
          </div>
          <div class="col-lg-2 col-md-2">
            <label class="required">Issue no</label>
            <input disabled type="text" formControlName="mi_number" class="form-control">
          </div>

          <div class="col-lg-2 col-md-2">
            <label class="required">Issue date</label>
            <div class="input-group datepicker-input">
              <input
                class="form-control"
                placeholder="dd-mm-yyyy"
                name="dp2"
                formControlName="mi_date"
                ngbDatepicker
                #d2="ngbDatepicker" 
              />
              <div class="input-group-append">
                <button class="btn btn-outline-secondary calendar" (click)="d2.toggle()" type="button">
                  <i class="fa fa-calendar" aria-hidden="true"></i>
                </button>
              </div>
            </div>
          </div>
  

          <div class="col-lg-2 col-md-2">
            <label>KM Reading</label>
            <input type="text" formControlName="mcreading" class="form-control" placeholder="KM Reading">
          </div>

        </div>

        <div class="form-group row">
          <div class="col-lg-3 col-md-3">
            <label class="required">Issued By</label>
            <select class="form-control" formControlName="issuedby">
              <option value="">Select Issued By</option>
              <option *ngFor="let i of issuedby_option" [value]="i.issuedby"> {{i.issuedby}}</option>
            </select>
          </div>

          <div class="col-lg-3 col-md-3">
            <label class="required">Issued For</label>
            <select class="form-control" formControlName="issuedfor">
              <option value="">Select Issued For</option>
              <option value="Maintenance">Maintenance</option>
              <option value="Tyre">Tyre</option>
            </select>
          </div>

          <div class="col-lg-3 col-md-3">
            <label class="required">Department</label>
            <ng-select [items]="dept_option" placeholder="Type and search Department" bindLabel="deptname" bindValue="deptname"
              formControlName="department">
            </ng-select>
          </div>
          
        </div>

        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
                Material Issue items
                <button class="btn btn-primary float-right" (click)="addMiItems()" [disabled]="!miForm.valid"
                  type="button">
                  Add Item
                </button>
              </div>
              <!-- /.box-header -->
              <div class="card-body" *ngIf="miForm.controls.materiali_items.controls.length > 0">
                <table class="table table-bordered" formArrayName="materiali_items">
                  <tr>
                    <th>Item</th>
                    <th>Unit</th>
                    <th>Godown</th>
                    <th>Qty</th>
                    <th>Price(<i class="fa fa-inr" aria-hidden="true"></i>)</th>
                    <th>Amount(<i class="fa fa-inr" aria-hidden="true"></i>)</th>
                    <th>Refund</th>
                    <th>Material Type</th>
                    <th>RefQty</th>
                    <th>Action</th>
                  </tr>
                  <tr *ngFor="let school of miForm.controls.materiali_items.controls; let i=index" formGroupName="{{i}}">
                    <td>
                      <div class="input-group ngs">
                        <div class="col-md-12">
                          <ng-select [items]="materiali_items" appendTo=".card-body" class="form-control" style="width:250px !important;" placeholder="Type and search items" bindLabel="name" bindValue="_id"
                          formControlName="item_id">
                        </ng-select>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="input-group">
                        <select class="form-control" formControlName="unit">
                          <option value="">Select units</option>
                          <option *ngFor="let option of unit_option" [value]="option"> {{option}}</option>
                        </select>
                      </div>
                    </td>
                    <td>
                      <div class="input-group">
                        <select class="form-control" formControlName="godown">
                          <option value="">Select godown</option>
                          <option *ngFor="let g of materiali_godowns" [value]="g.godown"> {{g.godown}}</option>
                        </select>
                      </div>
                    </td>
                    <td>
                      <input type="number" min="0"  formControlName="qty"
                        class="form-control qty">
                    </td>

                    <td>
                      <input type="number" min="0" formControlName="price" class="form-control price">
                    </td>
                    <td>
                      <input type="number" min="0" formControlName="total" class="form-control total">
                    </td>
                    <td>
                      <div class="input-group">
                        <select class="form-control" formControlName="refund">
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                        </div>
                    </td>                    

                    <td>
                      <div class="input-group">
                        <select class="form-control" formControlName="mat_type">
                          <option value="">Material Type</option>
                          <option value="Job">Job</option>
                          <option value="Scrap">Scrap</option>
                        </select>
                        </div>
                    </td>                    

                    <td>
                      <input type="number" min="0" formControlName="ref_qty"  class="form-control refqty">
                    </td>
                    <td>
                      <button class="btn btn-danger float-right" [disabled]="miForm.controls?.materiali_items.controls.length == 1" (click)="removeItems(i)" type="button">
                        <i class="fa fa-trash" aria-hidden="true"></i>
                      </button>
                    </td>
                  </tr>
                </table>
              </div>
              <!-- <div class="card-body" *ngIf="miForm.controls?.materiali_items.controls.length == 0">
                <p>Please select vendor</p>
              </div> -->
            </div>
          </div>
        </div>

        <div class="mt-3">
          <div class="form-group row">
            <div class="col-lg-6 col-md-6">
              <label class="">Narration</label>
              <input type="text" formControlName="narration" class="form-control" placeholder="Please enter narration">
            </div>
          </div>
          <div class="form-group row">
            <div class="col-lg-3 col-md-3">
              <label class="">Net Amt</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fa fa-inr" aria-hidden="true"></i></span>
                </div>
                <input type="number" min="0" formControlName="net_amount" class="form-control">
              </div>
            </div>
            <div class="col-lg-3 col-md-3">
              <label class="">Rounded off</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fa fa-inr" aria-hidden="true"></i></span>
                </div>
                <input type="number" min="0" formControlName="rounded_off" class="form-control">
              </div>
            </div>
            <div class="col-lg-3 col-md-3">
              <label class="required">Round of Type</label>
              <select class="form-control" formControlName="round_off_type">
                <option>Please select site</option>
                <option value="plus">Plus</option>
                <option value="minus">Minus</option>
              </select>
            </div>
            <div class="col-lg-3 col-md-3">
              <label class="">Total</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fa fa-inr" aria-hidden="true"></i></span>
                </div>
                <input type="number" min="0" formControlName="total_amount" class="form-control">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <button class="btn btn-success float-right" (click)="saveMi()" [disabled]="!miForm.valid || process == 'saving'" type="button">
          Save <i *ngIf="process == 'saving'" class="fa fa-spinner fa-spin"></i>
        </button>
      </div>
    </div>
  
  </form>
</div>